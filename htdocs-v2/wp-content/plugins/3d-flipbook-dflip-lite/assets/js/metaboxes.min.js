(function(t){t(document).ready(function(){var s="dflip-page-item",l="dflip-empty-page",d="dflip-page-thumb",r="dflip-active",c="dflip-update-hash",f="dflip-page-options",h=t("#dflip_page_list"),u=t("#dflip_pages_box"),v=t("#dflip_outline_box"),g="dflip_upload_media",m="dflip-tabs",_="dflip-tabs-list";t("#content").val(t("#dflip_settings").val());t(document).on("click","."+_+" a",function(e){e.preventDefault();var i=t(this).parent();if(i.hasClass(r))return;var a=t(this).attr("href").replace("!","");var o=t(this).closest("."+m).find(a);var n=i[0].nodeName=="LI"?i:t(this);var s=r;if(n.hasClass("nav-tab"))s+=" nav-tab-active";n.siblings().removeClass(s);n.addClass(s);o.siblings().removeClass(s);o.addClass(s);if(i.hasClass(c)){var l=this.hash.split("#").join("#!");window.location.hash=l;b(l)}});function b(e){var i=t("#post").attr("action");if(i){i=i.split("#")[0];t("#post").attr("action",i+e)}}if(window.location.hash&&window.location.hash.indexOf("!dflip-tab-")>=0){t("."+_).find('a[href="'+window.location.hash.replace("!","")+'"]').trigger("click");b(window.location.hash)}if(h.length>0){h.sortable({containment:u,items:"> ."+s});var w=h.find("."+s).length;h.find("."+s).each(function(e){t(this).attr("index",e)});h.append(y({},w))}w++;function k(t){var e=t.title||"Select File",i=t.text||"Send to dFlip",a=t.target;var o=t.multiple==true?"add":false;var n=wp.media({multiple:o,title:e,button:{text:i},library:{type:t.type}}).on("select",function(){var e=n.state().get("selection");if(o==false){var i=e.models[0].attributes.url;a.val(i);if(t.callback)t.callback(i)}else{if(t.callback)t.callback(e)}}).open()}t(document).on("click","#dflip_upload_pdf_source",function(e){e.preventDefault();k({target:t(this).parent().find("input"),type:"application/pdf"})});t(document).on("click","#dflip_upload_pdf_thumb,#dflip_upload_bg_image",function(e){e.preventDefault();k({target:t(this).parent().find("input"),type:"image"})});t(document).on("click",".dflip-page-list-add",function(t){t.preventDefault();var e=h.find("."+l);k({target:e.find("input"),type:"image",multiple:true,callback:function(t){for(var i=0;i<t.length;i++){e=h.find("."+l).removeClass(l).addClass(s);var a=t.models[i].attributes.url;e.find("input").val(a);e.find("."+d).attr("src",a);h.append(y({},w));w++}}})});function y(e,i){var a=e.src||"",o=e.title||"",n=e.content||"",s=e.hotspot||"";var p=t('<li class="'+l+'" index="'+i+'">');var e=t('<div class="'+f+'">');var r=t('<img class="'+d+'">');var c=t('<input type="text" name="_dflip[pages]['+i+'][url]" id="dflip-page-'+i+'-url"/>');p.append(r).append(e);e.append(c);C(p);return p}function C(e){var i=t('<ul class="dflip-page-actions">'),a=t('<li class="dflip-page-image-action dashicons dashicons-format-image" title="Change Image">'),o=t('<li class="dflip-page-edit-action dashicons dashicons-edit" title="Edit HotSpots">'),n=t('<li class="dflip-page-remove-action dashicons dashicons-trash" title="Remove Page">');i.append(a).append(o).append(n).appendTo(e)}t(document).on("click",".dflip-page-remove-action",function(){var e=confirm("Delete the page!");if(e==true){t(this).closest("."+s).remove()}});t(document).on("click",".dflip-page-edit-action",function(){var e=t(this).closest("."+s);p(e)});t(document).on("click",".dflip-outline-remove-action",function(){var e=confirm("Delete outline and its children!");if(e==true){if(t(this).closest(".outline-node").siblings(".outline-node").length==0){t(this).closest(".outline-node").closest(".outline-node").removeClass("outline-haschild")}t(this).closest(".outline-node").remove()}});t(document).on("click",".dflip-outline-add-action",function(e){var a=t(this).closest(".outline-node");var o=a.find(">.outline-nodes");var n=a.data("prefix")+"[items]"+"["+o.find(".outline-node").length+"]";i(o,n,{title:"",dest:""});a.addClass("outline-haschild");e.stopPropagation()});t(document).on("click",".outline-wrapper",function(){var e=t(".outline-active");var i=e.find(">.outline-wrapper > input[dtype='title']").val();var a=e.find(">.outline-wrapper > input[dtype='dest']").val();var o=e.find(">.outline-wrapper > label").html(i+" : ("+a+")");e.removeClass("outline-active");t(this).closest(".outline-node").addClass("outline-active")});t(document).on("click",".outline-collapse",function(){t(this).closest(".outline-node").toggleClass("outline-collapsed")});t(document).on("click",".dflip-page-image-action",function(){var e=t(this).closest("."+s);k({target:e.find("input"),type:"image",callback:function(t){e.find("."+d).attr("src",t)}})});t(".dflip-box .dflip-option >:input").on("change",function(){I();S(t(this))});C(t("."+s));function x(t){var e;var i=/(.+?):(is|not|contains|less_than|less_than_or_equal_to|greater_than|greater_than_or_equal_to)\((.*?)\),?/g;var a=[];while(e=i.exec(t)){a.push({check:e[1],rule:e[2],value:e[3]||""})}return a}function I(){t('.dflip-box[id^="dflip_"][data-condition]').each(function(){var e;var i=x(t(this).data("condition"));var a=(t(this).data("operator")||"and").toLowerCase();t.each(i,function(i,o){var n=t("#"+o.check);if(!n.length){return}var s=n.length?n.val().toString():"";var l=o.value.toString();var d;switch(o.rule){case"less_than":d=parseInt(s)<parseInt(l);break;case"less_than_or_equal_to":d=parseInt(s)<=parseInt(l);break;case"greater_than":d=parseInt(s)>parseInt(l);break;case"greater_than_or_equal_to":d=parseInt(s)>=parseInt(l);break;case"contains":d=s.indexOf(l)!==-1?true:false;break;case"is":d=s==l;break;case"not":d=s!=l;break}if("undefined"==typeof e){e=d}switch(a){case"or":e=e||d;break;case"and":default:e=e&&d;break}});if(e){t(this).animate({opacity:"show",height:"show"},200)}else{t(this).animate({opacity:"hide",height:"hide"},200)}delete e})}function S(t){var e=t.data("global");var i=t.val().trim();if(i==e||e==undefined&&i==""){t.addClass("dflip-global-active").removeClass("dflip-global-inactive")}else{t.addClass("dflip-global-inactive").removeClass("dflip-global-active")}}I();t('.dflip-box .dflip-option >:input[id^="dflip_"][data-global]').each(function(){S(t(this))});if(t("#dflip_outline").length>0){var z=JSON.parse(t("#dflip_outline").val());z=e(z,"items");if(z.length==void 0||z.length==0)z=[];o=z.length;var T=t('<div class="add-outline-btn button button-primary">Add New Outline</div>').appendTo(v).on("click",function(){i(v,"_dflip[outline]"+"["+o+"]",{title:"",dest:""});o++});a(v,z,"_dflip[outline]");n(v,".outline-wrapper")}});function e(t,i){if(t==void 0)return t;var a=t;if(t.length==void 0){a=[];for(var o in t){a.push(t[o])}}for(var n=0;n<a.length;n++){if(a[n]!==void 0&&a[n][i]!==void 0)a[n][i]=e(a[n][i],i)}return a}function i(e,i,o){var n=t('<div class="outline-node">').data("prefix",i),s=t('<div class="outline-wrapper">'),l=t("<label></label>").html(o.title+" : ("+o.dest+")"),d=t("<input name="+i+'[title]" dtype="title" placeholder="Name of outline"/>').val(o.title),p=t("<input name="+i+'[dest]" dtype="dest" placeholder="pagenumber or url"/>').val(o.dest),r=t('<div class="outline-nodes">'),c=t('<div class="outline-collapse dashicons dashicons-arrow-down-alt2">'),f=t('<ul class="dflip-outline-actions">'),h=t('<li class="dflip-outline-add-action dashicons dashicons-plus" title="Add Outline">'),u=t('<li class="dflip-outline-remove-action dashicons dashicons-trash" title="Remove Outline">');s.append(l).append(d).append(p).appendTo(n);n.append(s).append(r).append(c).appendTo(e);f.append(h).append(u).appendTo(s);if(o.items!==void 0){n.addClass("outline-haschild");a(r,o.items,i+"[items]")}return n}function a(t,e,a){if(e!==void 0&&e.length>0){for(var o=0;o<e.length;o++){var n=e[o];var s=i(t,a+"["+o+"]",n)}}return this}var o=0;function n(e,i){var a=t('<div class="drag-helper">').appendTo(e).hide();var n,s,l,d,p,r,c,f,h="",u,v=false,g=false;function m(t){if(f==void 0)return;var e=t.pageY-f.offset().top;document.title=e.toString();var i=e<5?"before":e>27?"after":"over";if(i!==h){h=i;f.removeClass("has-drag-over has-drag-before has-drag-after").addClass("has-drag-"+h)}a.html("Insert "+h+" "+f.find("label").html())}function _(t){if(t.find(".outline-node").length>0){t.addClass("outline-haschild")}else{t.removeClass("outline-haschild")}}function b(e,i){var a;if(i==void 0){a=e.parents(".outline-node").first();if(a.length==0){o++;a=e;i="_dflip[outline]["+o+"]";a.data("prefix",i)}else{i=a.data("prefix")}}else{a=e;a.data("prefix",i)}a.find(" >.outline-wrapper >input").each(function(){var e=t(this);var a=e.attr("name");var o=e.attr("dtype");e.attr("name",i+"["+o+"]")});var n=0;a.find(" >.outline-nodes > .outline-node").each(function(){b(t(this),i+"[items]["+n+"]");n++})}function w(){if(u!==void 0&&f!==void 0&&h!==""){var t=u.closest(".outline-node");var e=f.closest(".outline-node");var i=t.parents(".outline-node");if(t.has(e).length>0||t.is(e)){alert("Can't drop into child");return}if(h=="before"){t.insertBefore(e)}else if(h=="over"){f.siblings(".outline-nodes").append(t)}else if(h=="after"){t.insertAfter(e)}_(i);_(t);_(e);b(t)}}e.on("mousedown",function(e){if(e.srcElement.nodeName=="INPUT")return;u=t(e.srcElement).closest(i);if(e.button!==0)return;if(u.length==0)return;p=e.pageX-t(this).offset().left;r=e.pageY-t(this).offset().top;v=true}).on("mousemove",function(i){if(!g&&v==true){l=i.pageX-t(this).offset().left-p;d=i.pageY-t(this).offset().top-r;if(Math.abs(l)>5||Math.abs(d)>5){g=true;a.show();e.addClass("has-dragging");u.addClass("is-drag-source")}}if(g){n=i.pageX-t(this).offset().left;s=i.pageY-t(this).offset().top;a.css({left:n-20,top:s+15});m(i)}});t(window).on("mouseup",function(t){e.removeClass("has-dragging");if(u)u.removeClass("is-drag-source");if(f&&g==true){f.removeClass("has-drag-over has-drag-before has-drag-after");w()}g=false;v=false;a.hide();f=null;u=null});e.on("mouseover",i,function(e){if(v==true){if(f)f.removeClass("has-drag-over has-drag-before has-drag-after");f=t(this)}if(g==true&&f){m(e);f.addClass("has-drag-over")}})}var s;var l;var d;function p(e){function i(e){var i=t('<input class="dflip-hotspot-input" name="_dflip[pages]['+l.attr("index")+"][hotspots]["+e+']" />');i.val("[30,30,30,30,]");return i}if(s==void 0){s=t('<div class="dflip-page-modal media-modal">');var a=t('<div class="media-modal-content edit-attachment-frame ">'),o=t('<div class="media-frame-content">'),n=t('<div class="edit-media-header">'),d=t('<div class="page-modal-next right dashicons">'),c=t('<div class="page-modal-prev left dashicons">'),h=t('<div class="page-modal-close media-modal-close"><span class="media-modal-icon"></span></div>'),u=t('<div class="dflip-hotspot-header">'),v=t('<div class="dflip-add-hotspot button button-primary">Add Hot-Spot</div>'),g=t('<div class="dflip-remove-hotspot button button-secondary">Remove Hot-Spot</div>'),m=t('<input class="dflip-hotspot-dest" placeholder="Enter page number or url with http:\\\\"></div>'),_=t('<div class="page-modal-image-wrapper">'),b=t('<img class="page-modal-image">'),w=t('<input class="page-modal-html" >');s.divImage=_;s.image=b;s.content=w;s.dest=m;d.on("click",function(){var t=l.next();if(t.length>0&&t.hasClass("dflip-page-item")){p(t)}});c.on("click",function(){var t=l.prev();if(t.length>0&&t.hasClass("dflip-page-item")){p(t)}});h.on("click",function(){s.hide()});m.on("change",function(){if(f._hotspot!==void 0){f._hotspot.dest=t(this).val();f._hotspot.update()}});g.on("click",function(){var t=confirm("Delete hotspot?");if(t==true){f._hotspot.dispose(true);f.detach()}m.val("")});v.on("click",function(){var t=l.find(".dflip-hotspot-input");var e=l.attr("hotspots");if(e==void 0){e=l.find(".dflip-hotspot-input").length}var a=i(e);e++;l.attr("hotspots",e);l.find(".dflip-page-options").append(a);var o=new r([40,40,20,20,""],s.divImage);o.activate(f);o.target=a});_.append(b);u.append(v).append(m).append(g);o.append(u).append(_);n.append(c).append(d);a.append(n).append(o);s.append(h).append(a).appendTo(t("#dflip_pages_box"))}s.show();s.dest.val("");var k=e.find(".dflip-page-thumb").attr("src");s.image.attr("src",k);if(l!=void 0&&l.hotspots!=void 0){for(var y=0;y<l.hotspots.length;y++){l.hotspots[y].dispose()}}l=e;if(e.hotspots==void 0)e.hotspots=[];if(f!==void 0)f._el.hide();s.find(".dflip-hotspot").remove();var C=[];e.find(".dflip-hotspot-input").each(function(i){C[i]=t(this).val().substr(1).slice(0,-1).split(",");var a=new r(C[i],s.divImage);a.target=t(this);e.hotspots[i]=a})}var r=function(e,i){var a=this;a.left=e[0],a.top=e[1],a.width=e[2],a.height=e[3],a.dest=e[4],a.ref=i.find("img.page-modal-image");a._el=t('<div class="dflip-hotspot">');i.append(a._el);a.update();a._el.on("click",function(){a.activate(f)})};r.prototype.activate=function(t){t.attach(this);s.dest.val(this.dest)};r.prototype.deactivate=function(t){};r.prototype.dispose=function(t){this._el.off();this._el.remove();if(t==true&&this.target!==void 0){this.target.remove()}};r.prototype.updateSize=function(t){this.width=Math.round(1e4*t.width/this.ref.width())/100;this.height=Math.round(1e4*t.height/this.ref.height())/100};r.prototype.updatePosition=function(t){this.left=Math.round(1e4*t.left/this.ref.width())/100;this.top=Math.round(1e4*t.top/this.ref.height())/100;this.update()};r.prototype.update=function(){this._el.css({left:this.left+"%",top:this.top+"%",width:this.width+"%",height:this.height+"%"});if(this.target!==void 0){this.target.val("["+this.left+","+this.top+","+this.width+","+this.height+","+this.dest+"]")}};var c=function(){var e=this;e.initialized=false;e._hotspot=void 0;if(t.fn.draggable){e._el=t('<div class="dflip-hotspot-helper">').draggable({containment:"parent",drag:function(t,i){e._hotspot.updatePosition(i.position)}})}else{e._el=void 0}};c.prototype.attach=function(t){var e=this;if(e._hotspot!==void 0)e._hotspot.deactivate();e._hotspot=t;e.container=t._el.parent();e.container.append(e._el);if(e.initialized!=true){e._el.resizable({handles:"ne, se, sw, nw",resize:function(t,i){e._hotspot.updateSize(i.size);e._hotspot.updatePosition(i.position)}});e.initialized=true}e._el.css({left:t._el[0].style.left,top:t._el[0].style.top,width:t._el[0].style.width,height:t._el[0].style.height,display:"block"})};c.prototype.detach=function(t){if(this._hotspot!==void 0)this._hotspot.deactivate();this._el.hide()};var f=new c})(jQuery);