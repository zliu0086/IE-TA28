"use strict";var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(o,l){o.helpers=o.helpers||{},o.helpers.resizeTextarea=function(e){var t=e.outerHeight();e.css("overflowY","scroll");var i=e.prop("scrollHeight");e.css("overflowY","auto"),e.css("height","auto").css("height",t<i?i+2:t)},o.Quiz=function(){function t(e){_classCallCheck(this,t),this.$wrapper=e,this.questionsEl=e.find(".wp-quiz-questions"),this.resultsEl=e.find(".wp-quiz-results"),this.questionsBaseName="quizData[questions]",this.resultsBaseName="quizData[results]",this.store=window[this.name+"Quiz"],this.tracker={lastAddedQuestion:null,lastRemovedQuestionId:null,lastAddedAnswer:null,lastRemovedAnswerId:null,lastAddedResult:null,lastRemovedResultId:null},this.initTemplates(),this.loadQuestions(),this.loadResults(),this.loadEvents()}return _createClass(t,[{key:"initTemplates",value:function(){this.templates={question:wp.template("wp-quiz-"+this.name+"-question-tpl"),answer:wp.template("wp-quiz-"+this.name+"-answer-tpl"),result:wp.template("wp-quiz-"+this.name+"-result-tpl")}}},{key:"parseQuestion",value:function(e){return(e=l.extend({},this.store.defaultQuestion,e)).id||(e.id=o.helpers.getRandomString()),e}},{key:"parseAnswer",value:function(e){return(e=l.extend({},this.store.defaultAnswer,e)).id||(e.id=o.helpers.getRandomString()),e}},{key:"parseResult",value:function(e){return(e=l.extend({},this.store.defaultResult,e)).id||(e.id=o.helpers.getRandomString()),e}},{key:"loadQuestions",value:function(){var i=this;Object.values(this.store.questions).forEach(function(e,t){i.addQuestion(e,t,!1),i.$wrapper.find(".wq-color-picker").wpColorPicker(),i.resizeTextareas()})}},{key:"addQuestion",value:function(e,t,i){e=this.parseQuestion(e);var n=this.getQuestionTmplData(e,t),a=this.templates.question(n);if(a){var r=l(a);this.questionMediaType&&r.attr("data-media-type",e.mediaType);var s=r.find(".wp-quiz-answers");s.length&&(this.answerType&&s.attr("data-type",e.answerType),this.loadAnswers(s,e.answers||{})),this.questionsEl.find(".wp-quiz-questions-list").append(r),this.answerSortable&&this.sortAnswers(r),i&&(r.find(".wq-color-picker").wpColorPicker(),this.resizeTextareas()),this.tracker.lastAddedQuestion=e,this.addedQuestion(r,e,t)}}},{key:"getQuestionTmplData",value:function(e,t){return{question:e,baseName:this.questionsBaseName,index:t,i18n:o.i18n}}},{key:"addedQuestion",value:function(e,t,i){}},{key:"removeQuestion",value:function(e){this.tracker.lastRemovedQuestionId=e.attr("data-id"),e.remove(),this.reIndexQuestions()}},{key:"loadAnswers",value:function(i,e){var n=this,a=i.attr("data-base-name");Object.values(e).forEach(function(e,t){n.addAnswer(i,e,t,a,!1)})}},{key:"addAnswer",value:function(e,t,i,n,a){t=this.parseAnswer(t);var r=this.getAnswerTmplData(t,i,n),s=this.templates.answer(r);if(s){var u=l(s);e.find(".wp-quiz-answers-list").append(u),a&&this.resizeTextareas(),this.tracker.lastAddedAnswer=t,this.addedAnswer(u,t,i)}}},{key:"getAnswerTmplData",value:function(e,t,i){return{answer:e,baseName:i,index:t,i18n:o.i18n}}},{key:"addedAnswer",value:function(e,t,i){}},{key:"removeAnswer",value:function(e){this.tracker.lastRemovedAnswerId=e.attr("data-id"),e.remove()}},{key:"loadResults",value:function(){var i=this;Object.values(this.store.results).forEach(function(e,t){i.addResult(e,t,!1)})}},{key:"addResult",value:function(e,t,i){e=this.parseResult(e);var n=this.getResultTmplData(e,t),a=this.templates.result(n);if(a){var r=l(a);this.resultsEl.find(".wp-quiz-results-list").append(r),i&&this.resizeTextareas(),this.tracker.lastAddedResult=e,this.addedResult(r,e,t)}}},{key:"addedResult",value:function(e,t,i){}},{key:"getResultTmplData",value:function(e,t){return{result:e,baseName:this.resultsBaseName,index:t,i18n:o.i18n}}},{key:"removeResult",value:function(e){this.tracker.lastRemovedResultId=e.attr("data-id"),e.remove()}},{key:"loadEvents",value:function(){var i=this;this.$wrapper.on("click.addQuestion",".wp-quiz-add-question-btn",function(e){return i.handleClickAddQuestion(e)}),this.$wrapper.on("click.removeQuestion",".wp-quiz-remove-question-btn",function(e){return i.handleClickRemoveQuestion(e)}),this.$wrapper.on("click.addAnswer",".wp-quiz-add-answer-btn",function(e){return i.handleClickAddAnswer(e)}),this.$wrapper.on("click.removeAnswer",".wp-quiz-remove-answer-btn",function(e){return i.handleClickRemoveAnswer(e)}),this.$wrapper.on("click.addResult",".wp-quiz-add-result-btn",function(e){return i.handleClickAddResult(e)}),this.$wrapper.on("click.removeResult",".wp-quiz-remove-result-btn",function(e){return i.handleClickRemoveResult(e)}),this.$wrapper.on("click.uploadImage",".wp-quiz-image-upload-btn",function(e){return i.handleClickUploadImage(e)}),this.$wrapper.on("click.removeImage",".wp-quiz-image-upload-remove-btn",function(e){return i.handleClickRemoveImage(e)}),this.questionMediaType&&this.$wrapper.on("click.setMediaType",".wp-quiz-set-question-type-btn",function(e){return i.handleClickSetQuestionType(e)}),this.answerType&&this.$wrapper.on("click.setAnswerType",".wp-quiz-set-answer-type-btn",function(e){return i.handleClickSetAnswerType(e)}),this.videoUpload&&(this.$wrapper.find(".wp-quiz-video-upload").each(function(e,t){i.loadVideoPreview(l(t))}),this.$wrapper.on("click.loadVideoPreview",".wp-quiz-load-video-preview-btn",function(e){i.loadVideoPreview(l(e.currentTarget).closest(".wp-quiz-video-upload"))}),this.$wrapper.on("click",".wq-embed:not(.active)",function(e){if(e.currentTarget.querySelector("img")){var t=e.currentTarget.querySelector("iframe"),i=t.src;e.currentTarget.classList.add("active"),t&&(t.src=0<=i.indexOf("?")?i+"&autoplay=1":i+"?autoplay=1")}}),this.$wrapper.on("change",".wp-quiz-video-upload-url",function(e){return i.handleChangeVideoData(e)}),this.$wrapper.on("change",".wp-quiz-video-upload .wp-quiz-image-upload-url",function(e){return i.handleChangeVideoData(e)}),this.$wrapper.on("click.uploadVideo",".wp-quiz-upload-video-btn",function(e){return i.handleClickUploadVideoBtn(e)})),this.questionSortable&&this.sortQuestions(),this.resultSortable&&this.sortResults()}},{key:"handleClickAddQuestion",value:function(e){e.preventDefault();var t=this.questionsEl.find(".wp-quiz-question").length;this.addQuestion({},t,!0)}},{key:"handleClickRemoveQuestion",value:function(e){e.preventDefault();var t=l(e.currentTarget).closest(".wp-quiz-question");this.removeQuestion(t)}},{key:"handleClickAddAnswer",value:function(e){e.preventDefault();var t=l(e.currentTarget).closest(".wp-quiz-answers"),i=t.attr("data-base-name"),n=t.find(".wp-quiz-answer").length;this.addAnswer(t,{},n,i,!0)}},{key:"handleClickRemoveAnswer",value:function(e){e.preventDefault();var t=l(e.currentTarget).closest(".wp-quiz-answer");this.removeAnswer(t)}},{key:"handleClickRemoveResult",value:function(e){e.preventDefault();var t=l(e.currentTarget).closest(".wp-quiz-result");this.removeResult(t)}},{key:"handleClickUploadImage",value:function(e){e.preventDefault();var t=l(e.currentTarget),i=t.closest(".wp-quiz-image-upload"),n=void 0;if(t.closest(".wp-quiz-video-upload").length){var a=t.closest(".wp-quiz-question").attr("data-id");n=this.$wrapper.find('.wp-quiz-question[data-id="'+a+'"] .wp-quiz-image-upload-url')}else n=i.find(".wp-quiz-image-upload-url");var r=i.find(".wp-quiz-image-upload-id"),s=i.find(".wp-quiz-image-upload-preview"),u=i.attr("data-edit-text"),o=wp.media({multiple:!1,library:{type:["image"]}});o.on("open",function(){var e=void 0,t=void 0,i=void 0;r.length&&(e=r.val()),e&&(t=o.state().get("selection"),(i=wp.media.attachment(e)).fetch(),t.add(i))}),o.on("select",function(){var e=o.state().get("selection").first().toJSON();r.length&&r.val(e.id).trigger("change"),n.length&&n.val(e.url).trigger("change"),s.length&&s.html('<img src="'+e.url+'">'),u&&t.text(u),i.removeClass("no-image")}),o.open()}},{key:"handleClickRemoveImage",value:function(e){e.preventDefault();var t=l(e.currentTarget).closest(".wp-quiz-image-upload"),i=t.find(".wp-quiz-image-upload-url"),n=t.find(".wp-quiz-image-upload-id"),a=t.find(".wp-quiz-image-upload-preview"),r=t.find(".wp-quiz-image-upload-btn"),s=t.attr("data-upload-text");n.length&&n.val(""),i.length&&i.val(""),a.length&&a.html(""),s&&r.text(s),t.addClass("no-image")}},{key:"handleClickSetQuestionType",value:function(e){e.preventDefault();var t=l(e.currentTarget),i=t.closest(".wp-quiz-question"),n=t.attr("data-type");i.find(".wp-quiz-question-media-type").val(n),i.attr("data-media-type",n)}},{key:"handleClickSetAnswerType",value:function(e){e.preventDefault();var t=l(e.currentTarget),i=t.attr("data-type");t.closest(".wp-quiz-question").find(".wp-quiz-question-answer-type").val(i),t.closest(".wp-quiz-answers").attr("data-type",i)}},{key:"handleClickUploadVideoBtn",value:function(e){e.preventDefault();var t=l(e.currentTarget).closest(".wp-quiz-question").attr("data-id"),i=this.$wrapper.find('.wp-quiz-question[data-id="'+t+'"] .wp-quiz-video-upload-url'),n=wp.media({multiple:!1,library:{type:["video"]}});n.on("select",function(){var e=n.state().get("selection").first().toJSON();i.length&&i.val(e.url).trigger("change")}),n.open()}},{key:"handleChangeVideoData",value:function(e){var t=l(e.currentTarget).closest(".wp-quiz-video-upload");this.loadVideoPreview(t)}},{key:"resizeTextareas",value:function(){this.$wrapper.find("textarea[data-autoresize]").each(function(){o.helpers.resizeTextarea(l(this))})}},{key:"reIndexQuestions",value:function(){this.$wrapper.find(".wp-quiz-question").each(function(e){l(this).find(".wp-quiz-question-number").text(e+1)})}},{key:"loadVideoPreview",value:function(t){var i=t.find(".wp-quiz-video-upload-preview"),e=t.find(".wp-quiz-video-upload-url").val()||"",n=t.find(".wp-quiz-image-upload-url").val()||"",a=t.find(".wp-quiz-video-upload-error");if(e=e.trim(),n=n.trim(),a.html(""),i.html(""),t.addClass("no-video"),e){var r={video_url:e,poster_url:n},s=o.restUrl+"wp-quiz/v2/video-content",u=o.helpers.getRequest({url:s,method:"GET",data:r});u.done(function(e){i.html(e),t.removeClass("no-video")}),u.fail(function(e){a.text(JSON.stringify(e))})}}},{key:"sortAnswers",value:function(e){e.find(".wp-quiz-answers-list").sortable({items:"> .wp-quiz-answer",placeholder:"wp-quiz-answer wp-quiz-answer-placeholder",start:function(e,t){t.placeholder.height(t.item.height())}})}},{key:"sortQuestions",value:function(){var i=this;this.$wrapper.find(".wp-quiz-questions-list").sortable({items:"> .wp-quiz-question",placeholder:"wp-quiz-question wp-quiz-question-placeholder",start:function(e,t){t.placeholder.height(t.item.height())},update:function(e,t){i.sortAnswers(i.$wrapper),i.reIndexQuestions()}})}},{key:"handleClickAddResult",value:function(e){e.preventDefault();var t=this.resultsEl.find(".wp-quiz-result").length;this.addResult({},t,!0)}},{key:"sortResults",value:function(){this.$wrapper.find(".wp-quiz-results-list").sortable({items:"> .wp-quiz-result",placeholder:"wp-quiz-result wp-quiz-result-placeholder",start:function(e,t){t.placeholder.height(t.item.height())}})}},{key:"name",get:function(){return""}},{key:"questionSortable",get:function(){return!0}},{key:"answerSortable",get:function(){return!0}},{key:"resultSortable",get:function(){return!0}},{key:"videoUpload",get:function(){return!1}},{key:"questionMediaType",get:function(){return!1}},{key:"answerType",get:function(){return!1}}]),t}();var e={saveQuiz:function(){var n=l("form#post");n.length&&n.on("submit",function(e){var t=n.serializeObject();if(window.onbeforeunload=null,void 0!==t.quizData){var i=t.quizData;n.append('<textarea name="post_content" style="display: none;">'+JSON.stringify(i)+"</textarea>"),n.find(".wp-quiz-content-settings *[name]").removeAttr("name")}})},autoresizeTextarea:function(){l(document).on("keyup input","textarea[data-autoresize]",function(){o.helpers.resizeTextarea(l(this))}),l(document).on("wp-quiz-activated-tab",function(){l("textarea[data-autoresize]").each(function(){o.helpers.resizeTextarea(l(this))})})},leavingPageConfirmation:function(){window.onbeforeunload||l(".wp-quiz-meta-box-wrap").on("change, click",function(e){window.onbeforeunload||(window.onbeforeunload=function(e){return e.returnValue=window.postL10n.saveAlert,window.postL10n.saveAlert})})},changeColorsWhenSwitchSkin:function(){l(document).on("change","#wp_quiz_skin1",function(){l(this).prop("checked")&&l("#wp_quiz_background_color").iris("color","#f2f2f2")}),l(document).on("change","#wp_quiz_skin2",function(){l(this).prop("checked")&&l("#wp_quiz_background_color").iris("color","#ecf0f1")})},ready:function(){this.saveQuiz(),this.autoresizeTextarea(),this.leavingPageConfirmation(),this.changeColorsWhenSwitchSkin()}};l(document).ready(function(){e.ready()})}(wpQuizAdmin,jQuery);